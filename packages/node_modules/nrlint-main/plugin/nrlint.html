<script>
(function() {

    RED.plugins.registerPlugin('nrlint', {
        type: 'nrlint-main',
        onadd: function() {

            var myWorker = new Worker('resources/nrlint/nrlint-worker.js')
            myWorker.onmessage = function(event) {
                console.log(event.data);
                if (event.data.cmd === "result") {
                    $(".lint-message").remove();
                    displayResult(event.data.result);
                }
            }

            function registerLintPlugin(plugin) {
                if (plugin.worker) {
                    myWorker.postMessage({cmd:'load', url:"../"+plugin.worker})
                }
            }
            var plugins = RED.plugins.getPluginsByType('nrlint-rule');
            plugins.forEach(function(p) {
                registerLintPlugin(p)
            })

            function displayResult(result) {
                var warnCount = 0;
                var errCount = 0;
                var table = $('<table class="lint-message red-ui-info-table"></table>').appendTo(lcontent);
                var tableBody = $('<tbody>').appendTo(table);

                for (var i = 0; i < result.length; i++) {
                    resid = result[i].location[0];
                    if (result[i].severity === "warn") { warnCount++; }
                    if (result[i].severity === "error") { errCount++; }
                    let msg = $('<div class="lint-message red-ui-debug-msg"></div>').appendTo(lcontent)
                    var metaRow = $('<div class="lint-message red-ui-debug-msg-meta"></div>').appendTo(msg);
                    let severityStr = result[i].severity === "warn" ? "Warn" : "Error";
                    $('<span class="red-ui-debug-msg-name">'+ severityStr + '</span>').appendTo(metaRow);
                    $('<a>', { href: "#", class: "red-ui-debug-msg-name" }).text('node: ' + resid).appendTo(metaRow)
                        .on("click", function (closureItem) {
                            return function(evt) {
                                evt.preventDefault();
                                RED.view.reveal(closureItem);
                            }
                        }(resid));
                    var el = $('<span class="lint-message red-ui-debug-msg-payload"></span>').appendTo(msg);
                    $('<div></div>').text(result[i].message).appendTo(el);
                }
                $('<tr class="red-ui-help-info-row"><td>Warn</td><td align="right">'+warnCount+'</td></tr>').appendTo(tableBody);
                $('<tr class="red-ui-help-info-row"><td>Error</td><td align="right">'+errCount+'</td></tr>').appendTo(tableBody);
            }

            var lintTimer;
            function doLint() {
                if (!lintTimer) {
                    lintTimer = setTimeout(function() {
                        lintTimer = null;
                        myWorker.postMessage({cmd:'lint', config: RED.settings.nrlint, flow:RED.nodes.createCompleteNodeSet()})
                    },500);
                }
            }

            var lcontent = $("<div>").css({ "position": "relative", "height": "100%" });
            var ltoolbar = $('<div class="sidebar-header">' +
                '<span class="button-group">' +
                '<a id="lint-tab-clear" class="sidebar-header-button" href="#">' +
                '<i class="fa fa-trash"></i></a></span></div>').appendTo(lcontent);
            var lfooterToolbar = $('<div>' +
                '<span class="button-group">' +
                '<a id="lint-tab-open" class="sidebar-footer-button" href="#">' +
                '<i class="fa fa-desktop"></i></a></span></div>');

            // move initialize logic to this function.
            RED.events.on("registry:plugin-added", function (id) {
                var plugin = RED.plugins.getPlugin(id);
                    if (plugin.type === "nrlint-rule") {
                        registerLintPlugin(plugin)
                    }
            });
            RED.events.on("nodes:change", function (state) {
                //console.log("nrlint - node:change handler");
                doLint();
            });
            RED.events.on("flows:change", function (state) {
                //console.log("nrlint - flows:change handler");
                doLint();
            });
            RED.events.on("workspace:dirty", function (state) {
                //console.log("nrlint - workspace:dirty handler");
                doLint();
            });
            RED.sidebar.addTab({
                id: "lint",
                label: "lint",
                name: "Flow Linter",
                content: lcontent,
                enableOnEdit: true,
                pinned: true,
                iconClass: "fa fa-paw",
                action: "nrlint:show-lint-tab"
            });
            RED.actions.add("nrlint:show-lint-tab", function () {
                RED.sidebar.show("lint");
            });
            ltoolbar.find("#lint-tab-clear").click(function (e) {
                e.preventDefault();
                $(".lint-message").remove();
            });
        },
        onremove: function() {
            //console.log('nrlint:onremove');
        }
    });
})();
</script>
