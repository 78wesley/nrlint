<style>
    .red-ui-nrlint {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .red-ui-nrlint .red-ui-sidebar-header {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
    }
    .red-ui-nrlint .red-ui-sidebar-header > * {
        flex-shrink: 0;
    }

    .red-ui-nrlint .red-ui-editableList-border {
        border: none;
        border-radius: 0;
    }
    .red-ui-nrlint .red-ui-editableList-container {
        padding: 0;
    }
    .red-ui-nrlint-results li {
        padding:0;
    }
    .red-ui-nrlint-result {
        border-left: 8px solid rgba(0,0,0,0);
        padding: 6px;
    }
    .red-ui-nrlint-result:hover {
        background: var(--red-ui-list-item-background-hover);
    }
    .red-ui-nrlint-result-warning {
        border-color: var(--red-ui-border-color-warning)
    }
    .red-ui-nrlint-result-error {
        border-color: var(--red-ui-border-color-error)
    }
    .red-ui-nrlint-result-meta {
        color: var(--red-ui-secondary-text-color);
        font-size: 11px;
    }
    .red-ui-nrlint-result-message {
        color: var(--red-ui-primary-text-color);
    }

    #red-ui-settings-tab-nrlint {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        bottom: 0;
        overflow-y: scroll;
    }
    #red-ui-settings-tab-nrlint .red-ui-editableList {
    }
    #red-ui-settings-tab-nrlint .red-ui-editableList-border {
        border: none;
        border-radius: 0;
    }
    .red-ui-nrlint-rule-config {
        display: flex;
        align-items: start;
    }
    .red-ui-nrlint-rule-config.disabled .red-ui-nrlint-rule-name {
        color: var(--red-ui-secondary-text-color-disabled-active);
    }
    .red-ui-nrlint-rule-config.disabled label,
    .red-ui-nrlint-rule-config.disabled .red-ui-nrlint-rule-meta {
        color: var(--red-ui-secondary-text-color-disabled);
    }


    .red-ui-nrlint-rule-config > input[type="checkbox"] {
        flex-grow: 0;
        width: 30px;
    }
    .red-ui-nrlint-rule-config  > div {
        flex-grow: 1;
    }
    .red-ui-nrlint-rule-meta {
        font-size: 0.9em;
        color: var(--red-ui-secondary-text-color);
        margin-bottom: 3px;
    }
    label.red-ui-nrlint-rule-name {
        margin: 0;
    }

    .red-ui-nrlint-rule-opts label {
        margin: 0;
        line-height: 26px;
    }
    .red-ui-nrlint-rule-opts input[type="text"] {
        padding: 3px 3px;
        height: 26px;
        line-height: 26px;
        margin: 0 0 0 6px;
    }
    .red-ui-nrlint-rule-opts label {
        display: flex;
        align-items: center;
    }
    .red-ui-nrlint-rule-opts input[type="checkbox"] {
        margin: 0 6px 0 0;
    }

    button.red-ui-nrlint-status, .red-ui-nrlint-status {
        width: auto;
        padding: 0 3px;
        color: var(--red-ui-secondary-text-color);
    }
    .red-ui-nrlint-status-warn {
        color: var(--red-ui-text-color-warning);
    }
    .red-ui-nrlint-status-error {
        color: var(--red-ui-text-color-error);
    }

</style>
<script>
(function() {

    var linterRules = {}

    var settingsPane;

    function getSettingsPane() {
        var pane = $('<div id="red-ui-settings-tab-nrlint"></div>');
        var ruleList = $('<ol id="red-ui-nrlint-rules"></ol>').appendTo(pane).editableList({
            height: 'auto',
            addButton: false,
            addItem: function(row, index, item) {
                row.addClass('red-ui-nrlint-rule-config');
                item.ui = {};
                var activeCB = $('<input type="checkbox" id="nrlint-rule-active--'+item.name+'">')
                    .appendTo(row)
                    .on('change', function() {
                        item.ui.active(this.checked);
                    });

                var info = $('<div></div>').appendTo(row);
                item.ui.active = function(state) {
                    if (state === undefined) {
                        return activeCB.prop('checked');
                    } else {
                        activeCB.prop('checked', !!state);
                        row.toggleClass("disabled", !state);
                        if (item.meta.options) {
                            var optNames = Object.keys(item.meta.options);
                            optNames.forEach(function(opt) {
                                item.meta.options[opt].input.prop("disabled",!state);
                            });
                        }
                    }
                }
                item.ui.options = {};
                $('<label class="red-ui-nrlint-rule-name" for="nrlint-rule-active--'+item.name+'"></label>').text(item.name).appendTo(info);
                $('<div class="red-ui-nrlint-rule-meta"></div>').text(item.meta.docs.description).appendTo(info);

                if (item.meta.options) {
                    var optionList = $('<div class="red-ui-nrlint-rule-opts"></div>').appendTo(info);
                    var optNames = Object.keys(item.meta.options);
                    optNames.forEach(function(opt) {
                        item.ui.options[opt] = {};
                        var optProperties = item.meta.options[opt];
                        var optRow = $('<div></div>').appendTo(optionList);
                        var label = $('<label></label>').text(opt).appendTo(optRow);
                        if (optProperties.type === 'boolean') {
                            var checkbox = $('<input type="checkbox">').prependTo(label);
                            item.meta.options[opt].input = checkbox;
                            item.ui.options[opt].val = function() {
                                return checkbox.prop("checked");
                            };
                        } else {
                            var input = $('<input type="text">').appendTo(label);
                            if (optProperties.hasOwnProperty("default")) {
                                input.attr("placeholder",optProperties.default);
                            }
                            if (item.config && item.config[opt]) {
                                input.val(item.config[opt]);
                            }
                            item.meta.options[opt].input = input;
                            item.ui.options[opt].val = function() { return input.val() };

                        }
                    });
                }
                item.ui.active(item.config !== "off")
            }
        });

        var linterRuleNames = Object.keys(linterRules);
        linterRuleNames.sort();
        var currentSettings = getLintSettings();
        var ruleSettings = currentSettings.rules || {};
        linterRuleNames.forEach(function(name) {
            ruleList.editableList('addItem',{name:name,config:ruleSettings[name],meta:linterRules[name]})
        })
        return pane;
    }

    function getLintSettings() {
        var defaultSettings = RED.settings.nrlint || {rules: {}};
        var userSettings = RED.settings.get("nrlint",defaultSettings);
        for (var r in userSettings.rules) {
            if (userSettings.rules.hasOwnProperty(r)) {
                if (userSettings.rules[r] === true) {
                    userSettings.rules[r] = {};
                }
            }
        }
        return userSettings;
    }


    RED.plugins.registerPlugin('nrlint', {
        onadd: function() {
            var lintWorker = new Worker('resources/nrlint/nrlint-worker.js')
            lintWorker.onmessage = function(event) {
                if (event.data.cmd === "result") {
                    displayResult(event.data.result);
                } else if (event.data.cmd === "ruleAdded") {
                    linterRules[event.data.rule] = event.data.meta;
                }
            }

            function registerLintPlugin(plugin) {
                if (plugin.worker) {
                    lintWorker.postMessage({cmd:'load', url:"../"+plugin.worker})
                }
            }
            // Get the already-registered lint plugins
            var plugins = RED.plugins.getPluginsByType('nrlint-rule');
            plugins.forEach(function(p) {
                registerLintPlugin(p)
            })
            // Add a listener for lint plugins that register after this
            RED.events.on("registry:plugin-added", function (id) {
                var plugin = RED.plugins.getPlugin(id);
                    if (plugin.type === "nrlint-rule") {
                        registerLintPlugin(plugin)
                    }
            });

            // Called to request a new lint run. Throttles requests to max 1/s
            var lintTimer;
            function queueLint() {
                if (!lintTimer) {
                    lintTimer = setTimeout(function() {
                        lintTimer = null;
                        lintWorker.postMessage({cmd:'lint', config: getLintSettings(), flow:RED.nodes.createCompleteNodeSet()})
                    },1000);
                }
            }

            // Lint Settings Panel
            RED.userSettings.add({
                id:'nrlint',
                title: "Linter",
                get: getSettingsPane,
                close: function() {
                    var ruleSettings = {};
                    $("#red-ui-nrlint-rules").editableList("items").each(function() {
                        var rule = $(this).data('data');
                        if (!rule.ui.active()) {
                            ruleSettings[rule.name] = "off";
                        } else {
                            var keyCount = 0;
                            ruleSettings[rule.name] = {};
                            for (var opt in rule.ui.options) {
                                if (rule.ui.options.hasOwnProperty(opt)) {
                                    var v = rule.ui.options[opt].val();
                                    if (v !== "") {
                                        ruleSettings[rule.name][opt] = v;
                                        keyCount++;
                                    }
                                }
                            }
                            if (keyCount === 0) {
                                ruleSettings[rule.name] = true;
                            }
                        }
                    })
                    RED.settings.set("nrlint",{ rules: ruleSettings });
                    queueLint();
                }
            })

            function displayResult(result) {
                var warnCount = 0;
                var errCount = 0;
                resultList.editableList('empty');
                for (var i = 0; i < result.length; i++) {
                    if (result[i].severity === "warn") { warnCount++; }
                    if (result[i].severity === "error") { errCount++; }
                    resultList.editableList('addItem', result[i])
                }
                updateStatus({warn: warnCount, error: errCount});
            }

            function updateStatus(opts) {
                statusWidget.empty();
                var errorSpan = $('<span><i class="fa fa-exclamation-circle"></i> '+opts.error+'</span>').appendTo(statusWidget);
                if (opts.error > 0) {
                    errorSpan.addClass('red-ui-nrlint-status-error');
                }
                var warningSpan = $('<span style="margin-left: 3px;"><i class="fa fa-exclamation-triangle"></i> '+opts.warn+'</span>').appendTo(statusWidget);
                if (opts.warn > 0) {
                    warningSpan.addClass('red-ui-nrlint-status-warn');
                }
                statusHeader.empty();
                errorSpan.clone().appendTo(statusHeader)
                warningSpan.clone().css("margin-left", "8px").appendTo(statusHeader)
            }

            var content = $('<div class="red-ui-nrlint"></div>').css({"position":"relative","height":"100%"});
            var header = $("<div>", {class:"red-ui-sidebar-header"}).appendTo(content);
            var listContainer = $('<div></div>').css({"flex-grow":1,"overflow-y":"scroll"}).appendTo(content);

            var headerLeftSpan = $('<span>').css({"flex-grow":1,"text-align":"left","line-height":"25px"}).appendTo(header);
            var statusHeader = $('<span>',{class:"red-ui-nrlint-status"}).appendTo(headerLeftSpan);
            var headerRightSpan = $('<span>',{class:""}).appendTo(header);

            $('<button type="button" class="red-ui-sidebar-header-button"><i class="fa fa-cog"/></button>').appendTo(headerRightSpan).on("click", function(evt) {
                evt.preventDefault();
                RED.userSettings.show("nrlint")
            });
            $('<button type="button" class="red-ui-sidebar-header-button"><i class="fa fa-trash"/></button>').appendTo(headerRightSpan).on("click", function(evt) {
                evt.preventDefault();
                resultList.editableList('empty');
            });

            var resultList = $('<ol>',{class:"red-ui-nrlint-results"}).appendTo(listContainer).editableList({
                addButton: false,
                height: 'auto',
                addItem: function(row,index,item) {
                    var nodeId = item.location[0];
                    row.on("mouseenter", function(evt) {
                        item.location.forEach(function(id) {
                            var n = RED.nodes.node(id);
                            if (n) {
                                n.highlighted = true;
                                n.dirty = true;
                            }
                        });
                        RED.view.redraw();
                    }).on("mouseleave", function(evt) {
                        item.location.forEach(function(id) {
                            var n = RED.nodes.node(id);
                            if (n) {
                                n.highlighted = false;
                                n.dirty = true;
                            }
                        });
                        RED.view.redraw();
                    })
                    row.addClass("red-ui-nrlint-result");
                    if (item.severity === "warn") {
                        row.addClass("red-ui-nrlint-result-warning");
                    } else if (item.severity === 'error') {
                        row.addClass("red-ui-nrlint-result-error");
                    }
                    var metaRow = $('<div class="red-ui-nrlint-result-meta"></div>').appendTo(row);
                    var srcLink = $('<a href="#"></a>').css({
                        "display":"flex",
                        "align-items":"center"
                    }).appendTo(metaRow).on("click", function(evt) {
                        evt.preventDefault();
                        RED.view.reveal(nodeId);
                    });
                    var srcNode = RED.nodes.node(nodeId) ||  RED.nodes.subflow(nodeId)  ||  RED.nodes.group(nodeId) || RED.nodes.workspace(nodeId);
                    if (srcNode) {
                         RED.utils.createNodeIcon(srcNode, true).appendTo(srcLink).addClass("red-ui-node-icon-small");
                    } else {
                        $('<span>').addClass('red-ui-node-label').text(nodeId).appendTo(srcLink);
                    }
                    var el = $('<div class="red-ui-nrlint-result-message"></div>').text(item.message).appendTo(row);
                }
            });

            RED.sidebar.addTab({
                id: "lint",
                label: "lint",
                name: "Linter",
                content: content,
                enableOnEdit: true,
                pinned: true,
                iconClass: "fa fa-medkit",
                action: "nrlint:show-lint-tab"
            });

            var statusWidget = $('<button type="button" class="red-ui-footer-button red-ui-nrlint-status"></button>').on('click', function(evt) {
                RED.sidebar.show("lint");
            });
            updateStatus({warn: 0, error: 0});

            RED.statusBar.add({
                id: "nrlint",
                align: "right",
                element: statusWidget
            })

            RED.actions.add("nrlint:show-lint-tab", function () {
                RED.sidebar.show("lint");
            });

            RED.events.on("nodes:change", queueLint);
            RED.events.on("flows:change", queueLint);
            RED.events.on("workspace:dirty", queueLint);
        },
        onremove: function() {
            //console.log('nrlint:onremove');
        }
    });
})();
</script>
